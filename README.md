# nanostore-publisher

Publish UHRP Content with NanoStore

## Overview

This package allows you to create Universal Hash Resolution Protocol (UHRP) content publications and hosting contracts for files and data. Since UHRP URLs are content-addressed, they are self-authenticating. Since any UHRP host can advertise the availability of content, discovery is no longer controlled by a trusted third party as is the case with HTTP.

## Usage

Check out [NanoStore UI](https://github.com/p2ppsr/nanostore-ui) to see a file upload example with React.

The below code relies on the  [Babbage SDK](https://projectbabbage.com/sdk) to pay for a file to be hosted:

```js
const Babbage = require('@babbage/sdk')

(async () => {
// Get a reference to a File element somehow, or create one if using Node
const file = document.getElementById('file_upload_form_input').files[0]
const serverURL = 'https://nanostore.babbage.systems'

// Send an invoice to the server to get transaction outputs
const inv = await invoice({
  fileSize: file.size,
  retentionPeriod: 525600, // Host for one year
  serverURL
})

// Create an Action with Babbage SDK to pay the invoice
const tx = await Babbage.createAction({
  outputs: inv.outputs.map(x => ({
    satoshis: x.amount,
    script: x.outputScript
  })),
  description: 'Upload with NanoStore'
})

// Upload the file and submit the payment of the invoice
const response = await upload({
  referenceNumber: inv.referenceNumber,
  transactionHex: tx.rawTransaction,
  mapiResponses: tx.mapiResponses,
  inputs: tx.inputs,
  file,
  serverURL
})

// The file is now published
console.log(response)
})()
```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

*   [invoice](#invoice)
    *   [Parameters](#parameters)
*   [derivePaymentInfo](#derivepaymentinfo)
    *   [Parameters](#parameters-1)
*   [submitPayment](#submitpayment)
    *   [Parameters](#parameters-2)
*   [pay](#pay)
    *   [Parameters](#parameters-3)
*   [upload](#upload)
    *   [Parameters](#parameters-4)

### invoice

Creates an invoice for a NanoStore file hosting contract.

#### Parameters

*   `obj` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** All parameters are given in an object. (optional, default `{}`)

    *   `obj.config` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** config object, see config section. (optional, default `CONFIG`)
    *   `obj.fileSize` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The size of the file you want to host in bytes.
    *   `obj.retentionPeriod` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The whole number of minutes you want the file to be hosted for.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** The invoice object, containing `message` giving details, `identityKey` receipient's private key, `amount` (satoshis), `ORDER_ID`, for referencing this contract payment and passed to the `upload` function. The object also contains `publicURL`, which is the HTTP URL where the file will become available for the duration of the contract once uploaded and the `status`.

### derivePaymentInfo

Derives an output to pay for the NanoStore file hosting contract.

#### Parameters

*   `obj` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** All parameters are given in an object. (optional, default `{}`)

    *   `obj.recipientPublicKey` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Public key of the host receiving the payment.
    *   `obj.amount` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The number of satoshis being paid.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** The output object, contains the `script` and the amount of `satoshis`'.

### submitPayment

Submit a manually-created payment for NanoStore hosting

#### Parameters

*   `obj` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** All parameters are given in an object. (optional, default `{}`)

    *   `obj.config` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** config object, see config section. (optional, default `CONFIG`)
    *   `obj.orderID` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The hosting invoice reference.
    *   `obj.amount` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The number of satoshis being paid.
    *   `obj.payment` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The result of calling createAction which incorporates the payment output for the NanoStore hosting. Object that includes `inputs`, `mapiResponses`, `rawTx`.
    *   `obj.vout` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The output from the Action which corresponds to the payment for NanoStore hosting
    *   `obj.derivationPrefix` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The value returned from `derivePaymentInfo`
    *   `obj.derivationSuffix` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The value returned from `derivePaymentInfo`

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** The paymentResult object, contains the `uploadURL` and the `publicURL` and the `status`'.

### pay

Payment for the NanoStore file hosting contract.

#### Parameters

*   `obj` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** All parameters are given in an object. (optional, default `{}`)

    *   `obj.config` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** config object, see config section. (optional, default `CONFIG`)
    *   `obj.description` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The description to be used for the payment.
    *   `obj.orderID` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The hosting invoice reference.
    *   `obj.recipientPublicKey` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Public key of the host receiving the payment.
    *   `obj.amount` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The number of satoshis being paid.

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** The pay object, contains the `uploadURL` and the `publicURL` and the `status`'.

### upload

Uploads a file to NanoStore and pays an invoice, thereby starting the file hosting contract.

#### Parameters

*   `obj` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)?** All parameters are given in an object. (optional, default `{}`)

    *   `obj.uploadURL` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** The external URL where the file is uploaded to host it.
    *   `obj.publicURL` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** The public URL where the file can be downloaded from.
    *   `obj.file` **File?** The file to upload. This is usually obtained by querying for your HTML form's file upload `<input />` tag and referencing `tagElement.files[0]`.
    *   `obj.serverURL` **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The URL of the NanoStore server to contract with. By default, the Babbage NanoStore server is used. (optional, default `https://nanostore.babbage.systems`)
    *   `obj.onUploadProgress` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)?** A function called with periodic progress updates as the file uploads (optional, default `()=>{}`)
    *   `obj.config`   (optional, default `CONFIG`)

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)>** The publication object. Fields are `published=true`, `hash` (the UHRP URL of the new file), and `publicURL`, the HTTP URL where the file is published.

## License

The license for the code in this repository is the Open BSV License.
